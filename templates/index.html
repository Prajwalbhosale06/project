<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sign Language Video Call</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        #localVideo {
            transform: scaleX(-1);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Dynamic viewport height fix for mobile browsers */
        body {
            height: 100dvh; 
        }
        /* Subtitle Text Animation */
        .word-pop {
            animation: popIn 0.3s ease-out forwards;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans overflow-hidden flex flex-col">

    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-gray-900 flex items-center justify-center z-50 px-4">
        <div class="bg-white text-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="video" class="w-8 h-8 md:w-10 md:h-10 text-blue-600"></i>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2">Join Call</h1>
                <p class="text-gray-500 text-sm md:text-base">Real-time Sign Language Detection</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                    <input type="text" id="usernameInput" placeholder="Enter your name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Room ID</label>
                    <input type="text" id="roomIdInput" placeholder="e.g. 1234" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="joinCall()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                    <i data-lucide="phone"></i> Join Room
                </button>
            </div>
        </div>
    </div>

    <div id="appInterface" class="hidden flex-1 flex flex-col h-full relative">
        
        <div class="bg-gray-800 border-b border-gray-700 px-4 py-3 flex justify-between items-center shrink-0 z-20">
            <div class="flex flex-col">
                <h2 class="text-base md:text-xl font-bold flex items-center gap-2">
                    Room: <span id="displayRoomId" class="text-blue-400">---</span>
                </h2>
                <span id="displayUsername" class="text-xs text-gray-400">---</span>
            </div>
            <div class="bg-gray-700 px-3 py-1 rounded-full flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4 text-gray-400"></i>
                <span id="userCount" class="text-sm font-mono">1</span>
            </div>
        </div>

        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
            
            <div class="flex-1 p-2 md:p-4 min-h-0 overflow-y-auto bg-black/20" id="videoContainer">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 h-full" id="videoGrid">
                    <div class="relative bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700 aspect-video md:aspect-auto md:h-full">
                        <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
                        <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-0.5 rounded text-xs backdrop-blur-sm">You</div>
                    </div>
                </div>
            </div>

            <div class="w-full h-[45%] lg:w-80 lg:h-full flex flex-col gap-2 p-2 md:p-4 border-t lg:border-t-0 lg:border-l border-gray-700 bg-gray-900 shrink-0">
                
                <div class="bg-gray-800 rounded-xl p-3 flex-1 flex flex-col border border-gray-700 min-h-0 relative shadow-inner">
                    <div class="flex justify-between items-center mb-2 shrink-0 border-b border-gray-700 pb-2">
                        <h3 class="font-semibold flex items-center gap-2 text-blue-400 text-sm">
                            <i data-lucide="hand" class="w-4 h-4"></i> Sign Language Output
                        </h3>
                        <div class="flex items-center gap-2">
                            <button id="signToggleBtn" onclick="toggleSignDetection()" class="w-9 h-5 bg-gray-600 rounded-full relative transition-colors duration-200 focus:outline-none">
                                <div id="signToggleCircle" class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform duration-200"></div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="signsLog" class="flex-1 overflow-y-auto pr-1 scrollbar-hide bg-gray-900/50 rounded-lg p-3 text-lg md:text-xl font-medium leading-relaxed tracking-wide text-gray-300 break-words">
                        <span id="placeholderText" class="text-gray-600 text-sm italic block text-center mt-4">Turn on detection to see output...</span>
                    </div>
                    
                    <button onclick="clearSubtitles()" class="absolute bottom-3 right-3 text-xs text-gray-500 hover:text-white transition bg-gray-700/50 px-2 py-1 rounded">
                        Clear
                    </button>
                </div>

                <div class="bg-gray-800 rounded-xl p-3 h-[50%] lg:h-1/2 flex flex-col border border-gray-700 min-h-0">
                    <h3 class="font-semibold mb-2 text-green-400 text-sm flex items-center gap-2">
                        <i data-lucide="message-square" class="w-4 h-4"></i> Chat
                    </h3>
                    <div id="chatLog" class="flex-1 overflow-y-auto space-y-2 mb-2 pr-1 scrollbar-hide text-sm"></div>
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="Type..." class="flex-1 bg-gray-700 border-none rounded px-3 py-2 text-white text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                        <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded transition flex items-center justify-center">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 border-t border-gray-700 p-3 flex justify-center gap-6 shrink-0 z-20 pb-safe">
            <button onclick="toggleVideo()" id="btnVideo" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition shadow-lg">
                <i data-lucide="video" class="w-6 h-6"></i>
            </button>
            <button onclick="toggleAudio()" id="btnAudio" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition shadow-lg">
                <i data-lucide="mic" class="w-6 h-6"></i>
            </button>
            <button onclick="leaveCall()" class="p-3 rounded-full bg-red-600 hover:bg-red-700 transition shadow-lg">
                <i data-lucide="phone-off" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SOCKET_URL = window.location.origin; 
        let socket;
        let localStream;
        let username;
        let roomId;
        let peerConnections = {}; 
        let isVideoEnabled = true;
        
        let isSignDetectionEnabled = false; 
        let frameInterval;
        let lastDetectedSign = ""; 

        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        lucide.createIcons();

        // --- Toggle Sign Detection ---
        function toggleSignDetection() {
            isSignDetectionEnabled = !isSignDetectionEnabled;
            
            const btn = document.getElementById('signToggleBtn');
            const circle = document.getElementById('signToggleCircle');
            const placeholder = document.getElementById('placeholderText');

            if (isSignDetectionEnabled) {
                btn.classList.replace('bg-gray-600', 'bg-green-500');
                circle.classList.add('translate-x-4');
                if(placeholder) placeholder.innerText = "Listening for signs...";
            } else {
                btn.classList.replace('bg-green-500', 'bg-gray-600');
                circle.classList.remove('translate-x-4');
                if(placeholder) placeholder.innerText = "Detection paused.";
            }
        }

        // --- SUBTITLE LOGIC ---
        function addSignToLog(data) {
            const log = document.getElementById('signsLog');
            const placeholder = document.getElementById('placeholderText');
            
            if (placeholder) placeholder.remove();

            const cleanSign = data.sign.trim();
            if (cleanSign.toLowerCase() === lastDetectedSign.toLowerCase()) {
                return; 
            }
            lastDetectedSign = cleanSign;

            const wordSpan = document.createElement('span');
            wordSpan.innerText = cleanSign + " ";
            wordSpan.className = "word-pop inline-block mr-1 text-white"; 
            
            const oldWords = log.querySelectorAll('span');
            oldWords.forEach(w => w.classList.replace('text-white', 'text-gray-400'));

            log.appendChild(wordSpan);
            log.scrollTop = log.scrollHeight;
        }

        function clearSubtitles() {
            const log = document.getElementById('signsLog');
            log.innerHTML = '<span id="placeholderText" class="text-gray-600 text-sm italic block text-center mt-4">History cleared.</span>';
            lastDetectedSign = "";
        }

        // --- Standard WebRTC & Socket Code ---
        async function joinCall() {
            username = document.getElementById('usernameInput').value;
            roomId = document.getElementById('roomIdInput').value;

            if (!username || !roomId) {
                alert("Please enter both Name and Room ID");
                return;
            }

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;

                socket = io(SOCKET_URL);
                setupSocketListeners();

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appInterface').classList.remove('hidden');
                document.getElementById('displayRoomId').innerText = roomId;
                document.getElementById('displayUsername').innerText = username;

                startFrameProcessing();
                socket.emit('join-room', { roomId, userName: username });

            } catch (err) {
                console.error("Error accessing media:", err);
                alert("Could not access camera/mic.");
            }
        }

        function setupSocketListeners() {
            socket.on('connect', () => console.log("Connected:", socket.id));

            socket.on('user-joined', async (data) => {
                updateUserCount(data.roomUsers.length);
                await createPeerConnection(data.userId, true); 
            });

            socket.on('webrtc-offer', async (data) => {
                const pc = await createPeerConnection(data.senderId, false);
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('webrtc-answer', { targetId: data.senderId, answer });
            });

            socket.on('webrtc-answer', async (data) => {
                const pc = peerConnections[data.senderId];
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            });

            socket.on('webrtc-ice-candidate', async (data) => {
                const pc = peerConnections[data.senderId];
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            });

            socket.on('user-disconnected', (data) => {
                if (peerConnections[data.userId]) {
                    peerConnections[data.userId].close();
                    delete peerConnections[data.userId];
                }
                const videoEl = document.getElementById(`video-${data.userId}`);
                if (videoEl) videoEl.parentElement.remove();
                updateUserCount(Object.keys(peerConnections).length + 1); 
            });

            socket.on('sign-detected', (data) => {
                addSignToLog(data);
            });

            socket.on('receive-message', (data) => {
                addMessageToChat(data);
            });
        }

        async function createPeerConnection(userId, isInitiator) {
            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[userId] = pc;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', { targetId: userId, candidate: event.candidate });
                }
            };

            pc.ontrack = (event) => {
                const stream = event.streams[0];
                if (!document.getElementById(`video-${userId}`)) {
                    addRemoteVideoElement(userId, stream);
                }
            };

            if (isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('webrtc-offer', { roomId, targetId: userId, offer });
            }
            return pc;
        }

        function addRemoteVideoElement(userId, stream) {
            const container = document.createElement('div');
            container.className = "relative bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700 aspect-video md:aspect-auto md:h-full";
            
            const video = document.createElement('video');
            video.id = `video-${userId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.className = "w-full h-full object-cover";

            const label = document.createElement('div');
            label.className = "absolute bottom-2 left-2 bg-black/60 px-2 py-0.5 rounded text-xs backdrop-blur-sm";
            label.innerText = `User ${userId.slice(0,4)}`;

            container.appendChild(video);
            container.appendChild(label);
            document.getElementById('videoGrid').appendChild(container);
            updateUserCount(Object.keys(peerConnections).length + 1);
        }

        function updateUserCount(count) {
            document.getElementById('userCount').innerText = count || 1;
        }

        function startFrameProcessing() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const video = document.getElementById('localVideo');

            frameInterval = setInterval(() => {
                if (!isVideoEnabled || !isSignDetectionEnabled) return;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    const frameData = canvas.toDataURL('image/jpeg', 0.6); 
                    socket.emit('process-frame', {
                        frame: frameData,
                        roomId: roomId,
                        timestamp: Date.now()
                    });
                }
            }, 500); 
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            socket.emit('send-message', {
                roomId,
                userName,
                message: msg,
                timestamp: Date.now()
            });
            input.value = '';
        }

        function addMessageToChat(data) {
            const log = document.getElementById('chatLog');
            const item = document.createElement('div');
            const isMe = data.userId === socket.id;
            
            item.className = `p-2 rounded max-w-[85%] mb-2 break-words ${isMe ? 'bg-blue-600 ml-auto' : 'bg-gray-700'}`;
            item.innerHTML = `
                <div class="text-[10px] ${isMe ? 'text-blue-200' : 'text-gray-400'} mb-0.5">${data.userName}</div>
                <div class="text-white text-sm">${data.message}</div>
            `;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
        }

        function toggleVideo() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            isVideoEnabled = videoTrack.enabled;
            const btn = document.getElementById('btnVideo');
            if (isVideoEnabled) {
                btn.classList.replace('bg-red-600', 'bg-gray-700');
                btn.classList.replace('hover:bg-red-700', 'hover:bg-gray-600');
                btn.innerHTML = `<i data-lucide="video" class="w-6 h-6"></i>`;
            } else {
                btn.classList.replace('bg-gray-700', 'bg-red-600');
                btn.classList.replace('hover:bg-gray-600', 'hover:bg-red-700');
                btn.innerHTML = `<i data-lucide="video-off" class="w-6 h-6"></i>`;
            }
            lucide.createIcons();
        }

        function toggleAudio() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            const btn = document.getElementById('btnAudio');
            if (audioTrack.enabled) {
                btn.classList.replace('bg-red-600', 'bg-gray-700');
                btn.classList.replace('hover:bg-red-700', 'hover:bg-gray-600');
                btn.innerHTML = `<i data-lucide="mic" class="w-6 h-6"></i>`;
            } else {
                btn.classList.replace('bg-gray-700', 'bg-red-600');
                btn.classList.replace('hover:bg-gray-600', 'hover:bg-red-700');
                btn.innerHTML = `<i data-lucide="mic-off" class="w-6 h-6"></i>`;
            }
            lucide.createIcons();
        }

        function leaveCall() {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (socket) socket.disconnect();
            location.reload(); 
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>